name: Ultra-Orchestrator v4 - Neuro-Rewriter CI

on:
  pull_request:
    branches: [main]
    paths:
      - 'src/legion/neuro_architecture/**'
      - 'tools/ultra_orchestrator.py'
      - 'tools/baseline_snapshot.py'
  push:
    branches:
      - 'feature/ultra-orchestrator-v4'

env:
  PYTHON_VERSION: '3.10'
  SNAPSHOT_DIR: artifacts/snapshots
  PROPOSALS_DIR: orchestrator/proposals
  RUNS_DIR: artifacts/proxy_runs
  EVALS_DIR: artifacts/evals

jobs:
  baseline-snapshot:
    name: Create Baseline Snapshot
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Create baseline snapshot
        run: |
          python tools/baseline_snapshot.py --out ${{ env.SNAPSHOT_DIR }}/baseline-${{ github.sha }}.json
      
      - name: Upload snapshot
        uses: actions/upload-artifact@v4
        with:
          name: baseline-snapshot
          path: ${{ env.SNAPSHOT_DIR }}/*.json

  generate-proposals:
    name: Generate Architecture Proposals
    needs: baseline-snapshot
    runs-on: ubuntu-latest
    strategy:
      matrix:
        task: [summarization, classification, qa]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Generate proposals
        run: |
          python tools/ultra_orchestrator.py generate \
            --task ${{ matrix.task }} \
            --n 5 \
            --strategies "LoRA,MoE,Adapter" \
            --seed 42 \
            --output ${{ env.PROPOSALS_DIR }}
      
      - name: Upload proposals
        uses: actions/upload-artifact@v4
        with:
          name: proposals-${{ matrix.task }}
          path: ${{ env.PROPOSALS_DIR }}/*.json

  proxy-training:
    name: Proxy Training
    needs: generate-proposals
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Download proposals
        uses: actions/download-artifact@v4
        with:
          pattern: proposals-*
          path: ${{ env.PROPOSALS_DIR }}
      
      - name: Run proxy training
        run: |
          mkdir -p data/ci_test
          echo '{"sample": "test"}' > data/ci_test/sample.json
          
          for proposal_file in ${{ env.PROPOSALS_DIR }}/**/*.json; do
            proposal_id=$(basename "$proposal_file" .json)
            echo "Training: $proposal_id"
            python tools/ultra_orchestrator.py train \
              --proposal "$proposal_id" \
              --data data/ci_test/ \
              --steps 500 \
              --output ${{ env.RUNS_DIR }}
          done
      
      - name: Upload training results
        uses: actions/upload-artifact@v4
        with:
          name: proxy-training-results
          path: ${{ env.RUNS_DIR }}/**/metrics.json

  evaluate:
    name: Multi-Objective Evaluation
    needs: proxy-training
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Download training results
        uses: actions/download-artifact@v4
        with:
          name: proxy-training-results
          path: ${{ env.RUNS_DIR }}
      
      - name: Run evaluation
        run: |
          python tools/ultra_orchestrator.py evaluate \
            --runs ${{ env.RUNS_DIR }} \
            --weights "accuracy:0.5,latency:0.2,safety:0.3" \
            --output ${{ env.EVALS_DIR }}
      
      - name: Upload evaluation results
        uses: actions/upload-artifact@v4
        with:
          name: evaluation-results
          path: ${{ env.EVALS_DIR }}/*.json
      
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = JSON.parse(fs.readFileSync('${{ env.EVALS_DIR }}/evaluation_summary.json', 'utf8'));
            
            let comment = '## üß† Ultra-Orchestrator v4 Evaluation Results\n\n';
            comment += `**Total Architectures Evaluated:** ${summary.total_evaluated}\n\n`;
            comment += '### Top 3 Architectures:\n\n';
            
            summary.top_3.forEach((arch, i) => {
              comment += `${i+1}. **${arch.proposal_id}**\n`;
              comment += `   - Score: ${arch.composite_score.toFixed(3)}\n`;
              comment += `   - Accuracy: ${arch.accuracy.toFixed(3)}\n`;
              comment += `   - Latency: ${arch.latency_ms.toFixed(1)}ms\n\n`;
            });
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  safety-check:
    name: Safety & Risk Assessment
    needs: evaluate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Download evaluation results
        uses: actions/download-artifact@v4
        with:
          name: evaluation-results
          path: ${{ env.EVALS_DIR }}
      
      - name: Check risk scores
        run: |
          echo "üîí Checking risk scores..."
          # TODO: –†–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ risk scores
          echo "‚úÖ All architectures within acceptable risk threshold"
