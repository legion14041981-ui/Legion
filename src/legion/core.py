"""\nLegion Core Module - —Ä—É–∫–æ–≤–∏–Ω–¥–∏—Ü–∞ —Ä–∞–±–æ—Ç—ã –º–Ω–æ–≥–æ–∞–≥–µ–Ω—Ç–Ω–æ–≥–æ —Å–∏—Å—Ç–µ–º–∞.\n\n–≠—Ç–æ—Ç –º–æ–¥—É–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞:\n- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—é —ç–∫—Å–µ–∫—É—Ü–∏–∏ –∞–≥–µ–Ω—Ç–æ–≤\n- –î–∏—Å–ø–µ—Ç—á–µ—Ä–∏–∑–∞—Ü–∏—é –∑–∞–¥–∞—á\n- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥\n"""\n\nimport logging\nfrom typing import List, Dict, Any, Optional\nfrom abc import ABC\nfrom .database import LegionDatabase\nimport os\nfrom pathlib import Path\nfrom dotenv import load_dotenv\n\n# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è\nlogger = logging.getLogger(__name__)\n\n\ndef safe_load_dotenv() -> bool:\n    \"\"\"\n    –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ .env —Ñ–∞–π–ª–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫ –∫–æ–¥–∏—Ä–æ–≤–∫–∏.\n    \n    –†–µ–∞–ª–∏–∑—É–µ—Ç self-healing –º–µ—Ö–∞–Ω–∏–∑–º:\n    1. –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å UTF-8\n    2. –ü—Ä–∏ –æ—à–∏–±–∫–µ - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏–∑ UTF-16/CP1251/Latin-1\n    3. –ü–µ—Ä–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ UTF-8\n    \n    Returns:\n        bool: True –µ—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ —É—Å–ø–µ—à–Ω–∞, False –≤ –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ\n    \"\"\"\n    env_path = Path(__file__).parent.parent.parent / '.env'\n    \n    if not env_path.exists():\n        logger.warning(f\"‚ö†Ô∏è .env file not found at {env_path}\")\n        logger.info(\"üí° Create .env file with your configuration\")\n        return False\n    \n    try:\n        # –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å UTF-8\n        load_dotenv(env_path, encoding='utf-8')\n        logger.info(\"‚úÖ .env loaded successfully\")\n        return True\n    except UnicodeDecodeError as e:\n        logger.error(f\"‚ùå .env file has invalid UTF-8 encoding: {e}\")\n        logger.info(f\"üìù Attempting to fix encoding...\")\n        \n        try:\n            # –ü—Ä–æ—á–∏—Ç–∞—Ç—å –∫–∞–∫ –±–∞–π—Ç—ã\n            content = env_path.read_bytes()\n            \n            # –ü–æ–ø—ã—Ç–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å —Å —Ä–∞–∑–Ω—ã–º–∏ –∫–æ–¥–∏—Ä–æ–≤–∫–∞–º–∏\n            for encoding in ['utf-16', 'utf-16-le', 'utf-16-be', 'cp1251', 'cp1252', 'latin-1']:\n                try:\n                    text = content.decode(encoding)\n                    \n                    # –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é\n                    backup_path = env_path.with_suffix('.env.backup')\n                    backup_path.write_bytes(content)\n                    logger.info(f\"üì¶ Backup created: {backup_path}\")\n                    \n                    # –ü–µ—Ä–µ—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ UTF-8\n                    env_path.write_text(text, encoding='utf-8')\n                    logger.info(f\"‚úÖ Fixed encoding: {encoding} ‚Üí UTF-8\")\n                    \n                    # –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª\n                    load_dotenv(env_path)\n                    return True\n                    \n                except (UnicodeDecodeError, UnicodeEncodeError):\n                    continue\n            \n            logger.error(f\"‚ùå Could not fix encoding automatically\")\n            logger.info(f\"üí° Please recreate .env file manually with UTF-8 encoding\")\n            logger.info(f\"   Example content:\")\n            logger.info(f\"   OPENAI_API_KEY=your_key_here\")\n            logger.info(f\"   ANTHROPIC_API_KEY=your_key_here\")\n            logger.info(f\"   LEGION_OS_ENABLED=true\")\n            return False\n            \n        except Exception as e:\n            logger.error(f\"‚ùå Error fixing .env: {e}\")\n            return False\n    except Exception as e:\n        logger.error(f\"‚ùå Unexpected error loading .env: {e}\")\n        return False\n\n\n# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫\nif not safe_load_dotenv():\n    logger.warning(\"‚ö†Ô∏è Running without .env configuration\")\n\n\nclass LegionCore:\n    \"\"\"\n    –û—Å–Ω–æ–≤–Ω–æ–µ —è–¥—Ä–æ Legion Framework.\n    \n    –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –∑–∞—É—Å–∫ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç–∫–æ—Å–∏—Å—Ç–µ–º–æ–π –∞–≥–µ–Ω—Ç–æ–≤:\n    - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è\n    - –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è —ç–∫—Å–µ–∫—É—Ü–∏–∏\n    - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ\n    \n    Attributes:\n        agents (Dict[str, Any]): –°–ª–æ–≤–∞—Ä—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤\n        is_running (bool): –§–ª–∞–≥ —Å—Ç–∞—Ç—É—Å–∞ —Ä–∞–±–æ—Ç—ã –Ω–∞ —è–¥—Ä–∞\n    \"\"\"\n    \n    def __init__(self, config: Optional[Dict[str, Any]] = None):\n        \"\"\"\n        –û–±–∏—á–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ LegionCore.\n        \n        Args:\n            config (Dict[str, Any], optional): –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å–∏—Å—Ç–µ–º—ã. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é None.\n        \"\"\"\n        self.agents: Dict[str, Any] = {}\n        self.is_running: bool = False\n        self.config: Dict[str, Any] = config or {}\n\n                # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î\n        try:\n            self.db = LegionDatabase()\n            logger.info(\"Database connection established\")\n        except Exception as e:\n            logger.warning(f\"Database not available: {e}\")\n            self.db = None\n        \n        logger.info(\"LegionCore initialized\")\n    \n    def register_agent(self, agent_id: str, agent: Any) -> None:\n        \"\"\"\n        –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ –≤ —Å–∏—Å—Ç–µ–º–µ.\n        \n        Args:\n            agent_id (str): –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∞–≥–µ–Ω—Ç–∞\n            agent (Any): –û–±—ä–µ–∫—Ç –∞–≥–µ–Ω—Ç–∞\n        \"\"\"\n        # –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞\n        self.agents[agent_id] = agent\n        logger.info(f\"Agent '{agent_id}' registered\")\n\n            # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –ë–î\n        if self.db:\n            try:\n                self.db.register_agent(\n                    agent_id=agent_id,\n                    name=agent.__class__.__name__,\n                    config=agent.config\n                )\n            except Exception as e:\n                logger.error(f\"Failed to sync agent to database: {e}\")\n    \n    def dispatch_task(self, task_id: str, task_data: Dict[str, Any]) -> None:\n        \"\"\"\n        –î–∏—Å–ø–µ—Ç—á–µ—Ä–∏–∑–∞—Ü–∏—è –∑–∞–¥–∞—á–∏ –∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º—É –∞–≥–µ–Ω—Ç—É.\n        \n        Args:\n            task_id (str): –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–¥–∞—á–∏\n            task_data (Dict[str, Any]): –î–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏\n        \"\"\"\n        # –ü–ª–∞—Ü–µ—Ö–æ–ª–¥–µ—Ä –¥–ª—è –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∏–∑–∞—Ü–∏–∏\n        logger.debug(f\"Dispatching task '{task_id}' with data: {task_data}\")\n    \n    def start(self) -> None:\n        \"\"\"\n        –ó–∞–ø—É—Å–∫ —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –∞–≥–µ–Ω—Ç–æ–≤.\n        \"\"\"\n        self.is_running = True\n        logger.info(\"LegionCore started\")\n    \n    def stop(self) -> None:\n        \"\"\"\n        –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –∞–≥–µ–Ω—Ç–æ–≤.\n        \"\"\"\n        self.is_running = False\n        logger.info(\"LegionCore stopped\")\n    \n    def get_agent(self, agent_id: str) -> Optional[Any]:\n        \"\"\"\n        –ü–æ–ª—É—á–∏—Ç—å –∞–≥–µ–Ω—Ç–∞ –ø–æ –µ–≥–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É.\n        \n        Args:\n            agent_id (str): –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∞–≥–µ–Ω—Ç–∞\n        \n        Returns:\n            Optional[Any]: –û–±—ä–µ–∫—Ç –∞–≥–µ–Ω—Ç–∞ –∏–ª–∏ None\n        \"\"\"\n        return self.agents.get(agent_id)\n    \n    def get_all_agents(self) -> Dict[str, Any]:\n        \"\"\"\n        –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤.\n        \n        Returns:\n            Dict[str, Any]: –°–ª–æ–≤–∞—Ä—å –∞–≥–µ–Ω—Ç–æ–≤\n        \"\"\"\n        return self.agents.copy()\n